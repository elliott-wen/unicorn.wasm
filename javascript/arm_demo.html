<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Unicorn WASM</title>
    <script src="unicorn_wasm_arm.js"></script>
    <script src="unicorn-wrapper.js"></script>
</head>

<body>
    <h1>Unicorn WASM Loaded!</h1>
</body>
<script>
    // MUnicorn is the factory function
    MUnicorn().then(function (MUnicornInstance) {
        console.log("Unicorn WASM ready");

        const uc = createUC(MUnicornInstance);

        // Create an ARM emulator instance
        const emu = new uc.Unicorn(uc.ARCH_ARM, uc.MODE_ARM);
        console.log("Unicorn version:", uc.version());

        // ---- Test 1: Register read/write ----
        const testReg = uc.ARM_REG_R0;
        emu.reg_write_i32(testReg, 0x1234);
        const val = emu.reg_read_i32(testReg);
        console.log("Register R0 =", val.toString(16)); // expect 0x1234

        // ---- Test 2: Memory map + write/read ----
        const ADDRESS = 0x1000;
        const SIZE = 0x1000;
        emu.mem_map(ADDRESS, SIZE, uc.PROT_ALL); // RWX

        const data = new Uint8Array([0x01, 0x02, 0x03, 0x04]);
        emu.mem_write(ADDRESS, data);

        const readBack = emu.mem_read(ADDRESS, 4);
        console.log("Memory read back:", Array.from(readBack)); // expect [1,2,3,4]

        // ---- Test 3 + 4: Run instructions with memory hook ----
        // Assemble ARM mode instructions:
        //   MOV R0, #0x2000   ; target addr
        //   MOV R1, #0x42     ; store value
        //   STR R1, [R0]      ; write to memory
        //   LDR R2, [R0]      ; read from memory
        const CODE = new Uint8Array([
            0x42, 0x10, 0xa0, 0xe3, // mov r1, #0x42
            0x00, 0x10, 0x80, 0xe5, // str r1, [r0]
            0x00, 0x20, 0x90, 0xe5  // ldr r2, [r0]
        ]);

        // Map region at 0x2000 to be accessed by STR/LDR
        emu.mem_map(0x2000, 0x1000, uc.PROT_ALL);

        // Write code into memory
        emu.mem_write(ADDRESS, CODE);

        // Set R0 to 0x2000 manually because "mov r0,#0" loads 0 not 0x2000
        emu.reg_write_i32(uc.ARM_REG_R0, 0x2000);

        // Set PC to code start
        emu.reg_write_i32(uc.ARM_REG_PC, ADDRESS);

        // Add memory hook BEFORE emulation
        emu.hook_add(uc.HOOK_MEM_READ | uc.HOOK_MEM_WRITE,
            (ucInstance, type, address, size, value) => {
                console.log(`HOOK: type=${type}, addr=0x${address.toString(16)}, size=${size}, value=${value}`);
                return 0;
            });

        // Run 4 instructions
        emu.emu_start(ADDRESS, ADDRESS + CODE.length, 0, 4);

        // Check register result after LDR
        const r2 = emu.reg_read_i32(uc.ARM_REG_R2);
        console.log("R2 after LDR =", r2); // expect 0x42

        console.log("All tests completed.");
    });
</script>

</html>